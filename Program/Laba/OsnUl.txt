#pragma once
#include <math.h>
#include <fstream>
#include <iostream>
#include "Zadacha.h"
#include <iomanip>



using namespace std;

class OsnZadachaUl: public OsnovnayaZadacha {
protected:
	bool activee;
public:
	int nn, app;
	double MAX;
	double bet1, bet2; // ????? 1 ? 2 
	double h, max[1000];
	double x[1000];
	double xi[1000];
	double mu1, mu2;
	double a, b; // ??????? l
	double h1;// ?????? ??? ??????????????
	double alfa[1000], d[1000], fi[1000];
	ofstream fout;
	double A[1000];
	double B[1000]; 
	double C[1000]; 
	double F[1000];
	double Tochn[1000];
	double e;
	double allfa[1000];
	double y[1000]; 
	double betta[1000];

	OsnZadachaUl () {
	nn = 10, app = 10;
	MAX = 0;
	bet1 = 10, bet2 = -10; // ????? 1 ? 2 
	mu1 = 250, mu2 = -250;
	a = 0, b = 1; // ??????? l
	h1 = 0.0001;// ?????? ??? ??????????????
	}

	void TestClick (int n) {
	h = (b - a)/n;

	for (int i = 0; i <= n; i++)
	{
		x[i] = a + i*h;
		max[i] = 0;
	}

	for (int i = 0; i <= n - 1; i++) {
		xi[i] = a + (i + 0.5)*h;
	}

	for (int i = 1; i <= n; i++)
	{
		alfa[i] = (1/h) * IntegFA(x[i-1], x[i]);
		alfa[i] = 1/alfa[i];
	}
 		cout << endl; 
	for (int i = 1; i <= n - 1; i++)
	{
		d[i] = (1/h) * IntegFD(xi[i-1], xi[i]); 
	}

	for (int i = 1; i <= n - 1; i++)
	{
		fi[i] = (1/h) * IntegFFI(xi[i-1], xi[i]); //
	}

	fi[0] = (2/h) * IntegFFI(x[0], xi[0]);
	d[0] = (2/h) * IntegFD(x[0], xi[0]);
	
	fi[n] = (2/h) * IntegFFI(xi[n-1], x[n]);
	d[n] = (2/h) * IntegFD(xi[n-1], x[n]);

	// ----------- ????? ???????? ----------- //

	A[0] = 0;
	A[n] = -alfa[1]/(10*h+alfa[1] + (h*h)/2*d[0]);
	C[n] = 0;
	B[0] = 1;
	B[n] = 1;
	C[0] = -alfa[n]/(10*h+alfa[n] + (h*h)/2*d[n]);


	for (int i = 1; i <= n - 1; i++)
		A[i] = alfa[i]/(h*h);

	for (int i = 1; i <= n - 1; i++)
		B[i] = -((alfa[i])/(h*h) + (alfa[i+1])/(h*h) + d[i]);

	for (int i = 1; i <= n - 1 ; i++)
		C[i] = alfa[i+1]/(h*h);

	for(int i = 1; i <= n-1; i++)
		F[i] = -fi[i];


	F[0] = (fi[0] * (h*h)/2 + 250*h)/(10*h + alfa[1] + (h*h)/2 * d[0]);
	F[n] = (fi[n] * (h*h)/2 + 250*h)/(10*h + alfa[n] + (h*h)/2 * d[n]);




	allfa[0]=-C[0]/B[0];
	betta[0]=F[0]/B[0];
 
	for(int i = 1; i <= n - 1; i++)
	{
		e=A[i]*allfa[i-1]+B[i];
		allfa[i]=-C[i]/e; 
		betta[i]=(F[i]-A[i]*betta[i-1])/e;
	}

	y[n] = (F[n] - A[n] * betta[n - 1]) / (B[n] + A[n] * allfa[n - 1]);

	for (int i = n - 1; i >= 0; i--) 
	{
		y[i] = allfa[i] * y[i + 1] + betta[i];
	}
	// 
	// ???????????
	int n1 = n;
	n = n * 2;
	h = (b - a)/n;

	for (int i = 0; i <= n; i++)
	{
		x[i] = a + i*h;
		max[i] = 0;
	}

	for (int i = 0; i <= n - 1; i++) {
		xi[i] = a + (i + 0.5)*h;
	}

	for (int i = 1; i <= n; i++)
	{
		alfa[i] = (1/h) * IntegFA(x[i-1], x[i]);
		alfa[i] = 1/alfa[i];
	}
 		cout << endl; 
	for (int i = 1; i <= n - 1; i++)
	{
		d[i] = (1/h) * IntegFD(xi[i-1], xi[i]); 
	}

	for (int i = 1; i <= n - 1; i++)
	{
		fi[i] = (1/h) * IntegFFI(xi[i-1], xi[i]);
	}

	fi[0] = (2/h) * IntegFFI(x[0], xi[0]);
	d[0] = (2/h) * IntegFD(x[0], xi[0]);
	
	fi[n] = (2/h) * IntegFFI(xi[n-1], x[n]);
	d[n] = (2/h) * IntegFD(xi[n-1], x[n]);

	// ----------- ????? ???????? ----------- //


	A[0] = 0;
	A[n] = -alfa[1]/(10*h+alfa[1] + (h*h)/2*d[0]);
	C[n] = 0;
	B[0] = 1;
	B[n] = 1;
	C[0] = -alfa[n]/(10*h+alfa[n] + (h*h)/2*d[n]);


	for (int i = 1; i <= n - 1; i++)
		A[i] = alfa[i]/(h*h);

	for (int i = 1; i <= n - 1; i++)
		B[i] = -((alfa[i])/(h*h) + (alfa[i+1])/(h*h) + d[i]);

	for (int i = 1; i <= n - 1 ; i++)
		C[i] = alfa[i+1]/(h*h);

	for(int i = 1; i <= n-1; i++)
		F[i] = -fi[i];


	F[0] = (fi[0] * (h*h)/2 + 250*h)/(10*h + alfa[1] + (h*h)/2 * d[0]);
	F[n] = (fi[n] * (h*h)/2 + 250*h)/(10*h + alfa[n] + (h*h)/2 * d[n]);




	allfa[0]=-C[0]/B[0];
	betta[0]=F[0]/B[0];
 
	for(int i = 1; i <= n - 1; i++)
	{
		e=A[i]*allfa[i-1]+B[i];
		allfa[i]=-C[i]/e; 
		betta[i]=(F[i]-A[i]*betta[i-1])/e;
	}

	Tochn[n] = (F[n] - A[n] * betta[n - 1]) / (B[n] + A[n] * allfa[n - 1]);

	for (int i = n - 1; i >= 0; i--) 
	{
		Tochn[i] = allfa[i] * Tochn[i + 1] + betta[i];
	}
	// 
	// ????? ???????????

		// MAX
	max[0] = Tochn[0] - y[0];

	n = n1;
	h = (b - a)/n;
	for (int i = 0; i <= n; i++)
		x[i] = a + i*h;

	for(int i = 0; i <= n; i++)
	{
		max[i] = Tochn[i*2] - y[i];
	}


	for(int i = 0; i <= n; i++)

	if (abs(max[i]) > MAX)
	{
		MAX = abs(max[i]);
	}
	// ????? ???
}
	void TestVivodvfail (int n) {

		fout.open("VivodOsnUluch.txt");
		fout.setf(ios::fixed);
		fout << setw(8) << "x" << "   | " << "   U(x)" << "   | " << "   V(x)" << "   | " << "U(x) - V(x)" << endl;
		for(int i = 0; i <= n; i++)
		{
			fout  << x[i] << " | " << y[i] << " | " << Tochn[i*2] << " | " << max[i] << endl;
		}
		fout << fixed;
		fout.precision(15);
		fout << "max |U(x) - V(x)| = " << MAX << " on i=0,n" << endl;
		fout.precision(10);
		fout.close();
	}


};